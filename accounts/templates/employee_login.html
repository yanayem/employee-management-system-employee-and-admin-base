{% load static %}
<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="UTF-8">
  <title>Employee Portal | Managely</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{% static 'css/theme.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    integrity="sha512-pVtXkN6QPRk+9P1gTLuzbtS+0S6yG5VjsyV7u7DZq7G1bRmmNMC+Ocqk0E4/J2hUe3jq0+ZL3Nwkl6l0aA3/0w=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body class="theme-bg-primary min-h-screen flex items-center justify-center p-4 transition-colors duration-300">

  <!-- Dark/Light Toggle -->
  <div class="absolute top-4 right-4">
    <button id="theme-toggle" class="bg-gray-200 dark:bg-gray-700 p-2 rounded-full">
      <i id="theme-icon" class="fas fa-moon text-gray-800 dark:text-gray-200"></i>
    </button>
  </div>

  <div class="max-w-md w-full">
    <div class="theme-bg-primary rounded-2xl shadow-2xl p-8 theme-border border transition-colors duration-300">

      <!-- Header -->
      <div class="text-center mb-8">
        <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-user-tie text-white text-2xl"></i>
        </div>
        <h1 class="text-3xl font-bold theme-text-primary mb-2">Managely</h1>
        <p id="login-subtitle" class="theme-text-secondary">Employee Portal Login</p>
      </div>

      <!-- Login / First Login Form -->
      <form id="employee-form" class="space-y-6 relative">
        {% csrf_token %}

        <!-- Employee ID -->
        <div id="login-employee-id-div">
          <label class="block text-sm font-medium theme-text-primary mb-2">Employee ID</label>
          <input id="employee-id" type="text" name="employee_id"
            class="w-full theme-bg-secondary theme-border border rounded-lg px-4 py-3 theme-text-primary focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="Enter your employee ID" required>
        </div>

        <!-- Password -->
        <div class="relative">
          <label id="password-label" class="block text-sm font-medium theme-text-primary mb-2">Password</label>
          <input id="password" type="password" name="password"
            class="w-full theme-bg-secondary theme-border border rounded-lg px-4 py-3 theme-text-primary focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="Enter your password" required>
          <button type="button" id="toggle-password" class="absolute right-3 top-10 text-gray-900 hover:text-gray-700">
            <i class="fas fa-eye"></i>
          </button>
        </div>

        <!-- Confirm Password (first login only) -->
        <div id="confirm-password-div" class="hidden">
          <label class="block text-sm font-medium theme-text-primary mb-2">Confirm Password</label>
          <input id="confirm-password" type="password" name="confirm_password"
            class="w-full theme-bg-secondary theme-border border rounded-lg px-4 py-3 theme-text-primary focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="Confirm your password">
        </div>

        <!-- Submit Button -->
        <button type="submit" id="form-submit-btn" class="w-full btn-primary text-black py-3 rounded-lg font-medium">
          Sign In
        </button>

        <!-- Back Button -->
        <button type="button" onclick="window.location.href='/'"
          class="w-full mt-2 border border-gray-300 theme-text-primary py-3 rounded-lg font-medium hover:bg-gray-100 transition">
           Back to Portal Selection 
        </button>

        <div id="form-error" class="text-red-500 text-sm mt-4 text-center hidden"></div>
      </form>

    </div>
  </div>

  <script>
const form = document.getElementById("employee-form");
const employeeIdInput = document.getElementById("employee-id");
const passwordInput = document.getElementById("password");
const confirmPasswordDiv = document.getElementById("confirm-password-div");
const confirmPasswordInput = document.getElementById("confirm-password");
const submitBtn = document.getElementById("form-submit-btn");
const errorDiv = document.getElementById("form-error");
const loginSubtitle = document.getElementById("login-subtitle");

let firstLogin = false;

// CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

form.addEventListener("submit", async (e) => {
    e.preventDefault();
    errorDiv.classList.add("hidden");

    const employeeId = employeeIdInput.value.trim();
    const password = passwordInput.value.trim();
    const confirmPass = confirmPasswordInput.value.trim();

    if (!employeeId || !password) {
        errorDiv.textContent = "Employee ID and password are required.";
        errorDiv.classList.remove("hidden");
        return;
    }

    if (firstLogin && !confirmPass) {
        errorDiv.textContent = "Please confirm your new password.";
        errorDiv.classList.remove("hidden");
        return;
    }

    // Create a form to submit
    const tempForm = document.createElement("form");
    tempForm.method = "POST";
    tempForm.action = firstLogin ? "{% url 'accounts:change_password_first_login' %}" : "{% url 'accounts:login' %}";

    // CSRF token
    const csrfInput = document.createElement("input");
    csrfInput.type = "hidden";
    csrfInput.name = "csrfmiddlewaretoken";
    csrfInput.value = csrftoken;
    tempForm.appendChild(csrfInput);

    // Employee ID
    const employeeInput = document.createElement("input");
    employeeInput.type = "hidden";
    employeeInput.name = "employee_id";
    employeeInput.value = employeeId;
    tempForm.appendChild(employeeInput);

    // Password / New password
    const passwordField = document.createElement("input");
    passwordField.type = "hidden";
    passwordField.name = firstLogin ? "new_password" : "password";
    passwordField.value = password;
    tempForm.appendChild(passwordField);

    if (firstLogin) {
        const confirmField = document.createElement("input");
        confirmField.type = "hidden";
        confirmField.name = "confirm_password";
        confirmField.value = confirmPass;
        tempForm.appendChild(confirmField);
    }

    document.body.appendChild(tempForm);
    tempForm.submit();
});
</script>

</body>
</html>
